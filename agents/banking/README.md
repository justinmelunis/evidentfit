# Agent E: Banking Initialization

## Overview

The Banking Initialization Agent pre-computes and caches all evidence grades and reasoning for the 3-level banking system:

- **Level 1**: Goal × Supplement Evidence Grades (162 combinations)
- **Level 2**: Profile-Specific Reasoning (360 combinations) 
- **Level 3**: Real-time adjustments (never cached)

## Purpose

This agent runs when:
- Major research updates occur (new papers ingested)
- New profile combinations are needed
- Banking cache needs refresh

## Architecture

### Three-Level Banking System

**Level 1: Goal × Supplement Evidence (162 combinations)**
- Pre-computed evidence grades for every supplement × goal combination (6 goals × 27 supplements)
- **LLM Research Agent**: Reads and analyzes research papers to assign evidence grades (A/B/C/D)
- Grades based on research outcomes (positive/negative/mixed results), not just paper count
- **Supporting Publications**: Each evidence grade includes top 3 supporting research papers with full metadata
- Updated monthly when new research is ingested

**Level 2: Profile-Specific Reasoning (360 combinations)**
- Personalized "why" explanations based on demographics
- Generated by LLM analysis of research papers tailored to user profile
- **Profile-Specific Publications**: Each reasoning includes supporting research papers relevant to the user's demographic profile
- Profile combinations: 6 goals × 5 weight bins × 3 sexes × 4 age bins = 360 combinations

**Level 3: Real-Time Context Analysis (Never cached)**
- Dynamic modifications based on conversation context
- Text parsing for conditions, medications, specific interests
- **User-Specific Publications**: Real-time research papers relevant to user's specific context and conditions
- Applied in real-time for maximum personalization

## Files

- `run.py` - Main banking initialization script
- `run_banking_init.py` - Entry point script with environment setup
- `banking_loader.py` - Banking cache loader for API
- `level1_evidence_bank.json` - Level 1 banking cache
- `level2_reasoning_bank.json` - Level 2 banking cache
- `banking_summary.json` - Banking metadata and summary
- `banking_init.env` - Environment variables template

## Usage

### Local Development
```bash
cd agents/banking
python run_banking_init.py
```

### Docker
```bash
docker build -t evidentfit-banking .
docker run --env-file banking_init.env evidentfit-banking
```

## Environment Variables

Required environment variables (see `banking_init.env`):
- `FOUNDATION_ENDPOINT` - Azure AI Foundry endpoint
- `FOUNDATION_KEY` - Azure AI Foundry API key
- `SEARCH_ENDPOINT` - Azure AI Search endpoint
- `SEARCH_QUERY_KEY` - Azure AI Search query key
- `INDEX_VERSION` - Current index version

## Output

The agent generates:
- `level1_evidence_bank.json` - 162 evidence grades with supporting publications
- `level2_reasoning_bank.json` - 360 profile-specific reasoning sets
- `banking_summary.json` - Metadata and summary information
- `banking_init.log` - Detailed logging of the initialization process

## Integration

The banking caches are consumed by:
- **Agent B (User API)**: Loads banking data for fast personalized recommendations
- **Frontend**: Exposes Level 1 data via `/supplements/evidence` endpoint
- **Stack Planner**: Uses all three levels for comprehensive personalization

## Performance

- **Level 1**: ~162 LLM calls (one per goal×supplement combination)
- **Level 2**: ~360 LLM calls (one per profile combination)
- **Total**: ~522 LLM calls for complete initialization
- **Runtime**: 30-60 minutes depending on LLM response times
- **Storage**: ~3MB total for all banking caches

## Monitoring

The agent provides detailed logging:
- Progress updates every 20 Level 1 combinations
- Progress updates every 50 Level 2 combinations
- Individual supplement grades and paper counts
- Error handling and retry logic
- Final summary with completion statistics
